# NFL Lineup Cohesion Platform

A dockerized monorepo that ingests nflverse data, computes system-state level participation metrics, exposes a FastAPI analytics API and provides a Next.js UI for building and evaluating NFL lineups.

## Project structure

```
backend/   FastAPI app, ETL scripts, tests
frontend/  Next.js 14 App Router UI (Tailwind + shadcn-inspired components)
db/        Postgres schema & bootstrap SQL
seeds/     CSV templates for coaches and role weights
docker-compose.yml  Local orchestration (db + backend + frontend)
```

## Getting started

1. **Install dependencies** (optional if running via Docker):
   ```bash
   pip install -r backend/requirements.txt
   npm install --prefix frontend
   ```

2. **Start the stack**
   ```bash
   make up
   ```
   This builds and starts Postgres, the FastAPI backend (`http://localhost:8000`) and the Next.js frontend (`http://localhost:3000`).

3. **Run the ETL** (downloads nflverse participation/pbp data and populates aggregates):
   ```bash
   make etl  # executes the loader + coaches + aggregate scripts
   ```
   You can pass `--seasons` to restrict the ETL window, e.g. `python backend/etl/etl_load_nflverse.py --seasons 2023 2024`.

4. **Run tests**
   ```bash
   make test
   ```

### Environment

The backend reads `DATABASE_URL` (defaults to the Postgres service in docker compose). Other useful variables:

- `BACKEND_PORT` (default `8000`)
- `FRONTEND_PORT` (default `3000`)
- `NEXT_PUBLIC_API_BASE_URL` (frontend -> backend, default `http://localhost:8000/api`)

## ETL scripts

All ETL scripts live in `backend/etl` and share utilities for position mapping and system state hashing.

| Script | Purpose |
| ------ | ------- |
| `etl_load_nflverse.py` | Pull nflverse play-by-play + participation + player metadata for selected seasons. |
| `etl_load_coaches.py` | Load `seeds/coach_roles.csv` (OC/DC + play-caller windows) into Postgres. |
| `etl_compute_states.py` | Join plays with coach windows to stamp offense/defense system_state_id per snap. |
| `etl_aggregates.py` | Produce per-player snap totals, role entropy inputs and weighted co-snap counts. |

All scripts accept CLI flags (`--seasons`, `--force`, `--csv-path`) and can be re-run idempotently.

## API surface

- `GET /api/meta/seasons` – distinct seasons available in the warehouse
- `GET /api/teams?season=YYYY`
- `GET /api/system_state?team=KC&side=offense`
- `GET /api/system_state/summary?team=KC&side=offense&system_state_id=…`
- `GET /api/roster?team=KC&side=offense&system_state_id=…`
- `POST /api/score/lineup` – compute LSU/LIU/LIC + weighted cohesion for an 11-player lineup
- `GET /api/coaches/active?team=KC&date=2024-10-01`

The OpenAPI schema is auto-generated by FastAPI at `/docs`.

## Frontend

- Built with Next.js 14 App Router, Tailwind CSS and shadcn-inspired components.
- Local state managed with zustand (`useLineupStore`), lineup persistence stored in `localStorage`.
- `/builder` provides season → team → system state pickers, roster table, lineup slots, cohesion summary and a chemistry heatmap.
- `/coaches` visualizes active coordinators/play-callers and the system-state history for a team.

## Updating coaches & weights

- `seeds/coach_roles.csv` lists OC/DC/PlayCaller windows (see examples inside the file). Append new rows and re-run `make etl` to refresh.
- `seeds/role_pair_weights.csv` configures default LIC weights. Adjust values and reapply via the ETL.

## Testing

`pytest` covers:
- system state resolution preference (play-caller vs coordinator)
- LSU/LIU/LIC calculations on synthetic data
- API validation and happy-path scoring

Playwright scaffolding is included via `npm run test:e2e` for future UI automation.

